{% extends 'base.html.twig' %}

{% block title %}
    {{ editMode ? 'Modifier un enseignant' : 'Ajouter un enseignant' }}
{% endblock %}

{% block body %}
    <div class="container mt-4">
        <h1>{{ editMode ? 'Modifier un enseignant' : 'Ajouter un enseignant' }}</h1>
        {% if editMode and form.vars.value.modules is not empty %}
        <h2>{{ form.vars.value.prenom}} {{ form.vars.value.nom}}</h2>
        <div class="mb-4 p-3 border rounded bg-light">
            <h3>Modules enseignés :</h3>
            <ul>
                {% for module in form.vars.value.modules %}
                    {% set heuresEffectuees = 0 %}
                    {% for intervention in interventions %}
                        {% if intervention.module.id == module.id %}
                            {# Calculer la durée en heures #}
                            {% set heuresEffectuees = heuresEffectuees + ((intervention.dateFin.timestamp - intervention.dateDebut.timestamp) / 3600) %}
                        {% endif %}
                    {% endfor %}
                <li>
                    {{ module.description }} : {{ module.nbHeure }}h
                    ({{ (module.nbHeure - heuresEffectuees)|round(2) }}h restantes pour cette année)
                </li>
                    {% endfor %}
            </ul>
        </div>
        {% endif %}


        {{ form_start(form) }}
            
            {# On affiche les champs un par un pour pouvoir personnaliser "modules" #}
            {{ form_row(form.nom) }}
            {{ form_row(form.prenom) }}
            {{ form_row(form.email) }}

            <div class="mb-3">
                {{ form_label(form.modules) }}
                {{ form_widget(form.modules, {'attr': {'class': 'tomselect'}}) }}
                {{ form_errors(form.modules) }}
            </div>

            <div class="mt-3 d-flex justify-content-between">
                <a href="{{ path('corps_enseignant_list') }}" class="btn btn-bleu">Retour à la liste</a>
                <button class="btn btn-primary">
                    {{ editMode ? 'Enregistrer les modifications' : 'Ajouter' }}
                </button>
            </div>

        {{ form_end(form) }}

        {% if editMode %}
        <hr>
        <h3>Interventions de {{ form.vars.value.prenom}} {{ form.vars.value.nom}}</h3>

        {% if interventions is not empty %}            
            <form method="get" action="#" class="mb-3 d-flex" style="gap: 10px;">
            <label for="filterModule" class="form-label m-0 fw-bold">Filtrer par module :</label>
            <select id="filterModule" name="filtreModule" class="form-control" style="max-width: 250px;">
                <option value="all">Tous les modules</option>
                {% for module in form.vars.value.modules %}
                    <option value="{{ module.id }}">{{ module.nom }}</option>
                {% endfor %}
            </select>
            <button type="submit" class="btn btn-jaune">Filtrer</button>
            </form>

        <a href="{{ path('corps_enseignant_export_interventions', {id: form.vars.value.id}) }}" 
                class="btn btn-bleu btn-success mb-3">
                <i class="bi bi-file-earmark-excel"></i> Exporter en Excel
            </a>
        <table class="table table-striped table-bordered mt-3" id="interventionTable">
            <thead class="table-dark">
                <tr>
                    <th>Date de l'intervention</th>
                    <th>Module</th>
                    <th>Type</th>
                    <th>Intervenants</th>
                </tr>
            </thead>            

            <tbody>
                {% for intervention in interventions %}
                    <tr data-module="{{ intervention.module.nom }}">
                        <td>
                        {{ intervention.dateDebut|date('d/m/Y') }}
                        ({{ intervention.dateDebut|date('H:i') }} - {{ intervention.dateFin|date('H:i') }})
                        </td>
                        <td>{{ intervention.module.nom }}</td>
                        <td>{{ intervention.typeIntervention.nom }}</td>
                        <td>
                            {% for enseignant in intervention.corpsEnseignants %}
                                {% if enseignant.id != form.vars.value.id %}
                                    {{ enseignant.prenom }} {{ enseignant.nom }}{% if not loop.last %}, {% endif %}
                                {% endif %}
                            {% else %}
                                <span class="text-muted">Aucun autre intervenant</span>
                            {% endfor %}
                        </td>
                    </tr>
                {% endfor %}
            </tbody>
        </table>
        {% else %}
            <p class="text-muted">Aucune intervention associée à cet enseignant.</p>
        {% endif %}
            <hr>
            <form method="post"
                  action="{{ path('corps_enseignant_delete', {'id': form.vars.value.id}) }}"
                  onsubmit="return confirm('Êtes-vous sûr de vouloir supprimer cet enseignant ?');">
                <input type="hidden" name="_token" value="{{ csrf_token('delete' ~ form.vars.value.id) }}">
                <button class="btn btn-rouge">Supprimer</button>
            </form>
        {% endif %}
    </div>
{% endblock %}
